# Shadow Hunter: System Architecture Quick Guide

Shadow Hunter is a real-time, AI-driven active defense cybersecurity platform. It is engineered to detect, verify, and neutralize "Shadow AI"—the unauthorized use of generative AI tools (e.g., ChatGPT, Claude) or covert automated communication that standard firewalls classify as benign web browsing.

To achieve this, Shadow Hunter bypasses traditional header inspections and instead analyzes the behavioral topography and cryptographic fingerprints of network traffic.

---

## The Four-Stage Architecture

### 1. The Capture Layer (Listener & Event Parsing)

**Purpose:** Intercept raw network packets off the wire and convert them into structured event telemetry.

*   **Live Mode (`services/listener`):** Utilizes `scapy` (or natively bound packet capture libraries) to hook directly into the host machine's network interface, capturing raw packets in real-time.
*   **Demo Mode (`services/simulator`):** A high-fidelity traffic generation engine used for evaluation. It instantiates virtual "Personas" that synthesize realistic corporate network traffic interspersed with stealthy Shadow AI usage logic.
*   **Event Condensation:** Raw packets are streamlined into `NetworkFlowEvent` objects. This significantly reduces memory overhead by retaining only vital metadata: `source_ip`, `dest_ip`, `dest_port`, `bytes_sent`, `bytes_received`, `duration`, and TLS handshake parameters.
*   **Message Broker (`services/broker`):** NetworkFlowEvents are pushed asynchronously into an in-memory queue, allowing the core intelligence engine to scale and process thousands of events per second without packet starvation or dropped connections.

**Operational Example:**
> A Python script initiates an Anthropic Claude API query. The Capture Layer intercepts the TCP connection to `34.102.136.x`, recording that internal node `192.168.1.5` transmitted 850 bytes and received 4,200 bytes over exactly 1.2 seconds, before pushing this telemetry to the broker.

### 2. The Intelligence Engine (Enrichment & Machine Learning)

**Purpose:** Ingest event telemetry, enrich the data with threat intelligence, and assign a mathematical Risk Score using comprehensive machine learning models.

*   **CIDR Threat Intel (`pkg/data/cidr_threat_intel.py`):** Acts as a primary fast-filter mechanism. The system matches destination IPs against a curated database of known AI provider IP blocks. Matches are instantly tagged with base provider constraints.
*   **Feature Extraction:** Telemetry is transformed into actionable metrics. The system calculates dimensional features such as the "byte ratio" (bytes received ÷ bytes sent), packet cadence, and connection regularity.
*   **The Triad ML Pipeline (`services/intelligence`):** Events are evaluated concurrently through three distinct models:
    1.  **Isolation Forest:** A robust statistical anomaly detector trained on baseline corporate traffic. Events manifesting significantly outside the established hyper-dimensional norm are flagged.
    2.  **Deep Autoencoder:** A neural network architecture designed for data reconstruction. Trained exclusively on normal browser traffic, it attempts to compress and reconstruct the event. A structural deviation, like a zero-day API format, produces a high "Reconstruction Error," signaling an anomaly.
    3.  **Random Forest Classifier:** A supervised model formulated to evaluate packet cadence and byte telemetry. It yields a high-confidence probabilistic score indicating whether communication is generated by an automated API call or manual human web browsing.

**Operational Example:**
> Processed telemetry indicates a low latency interaction with extreme size asymmetry (small prompt out, massive payload in) and perfectly static timing. The Random Forest assigns a 98% confidence score confirming a programmatic API call, bypassing traditional SIEM heuristics.

### 3. Active Defense & Validation

**Purpose:** Positively verify ML predictions, eliminate false positives through active interrogation, and identify lateral exfiltration topologies.

*   **Active Interrogator (`services/active_defense/interrogator.py`):** Modifies the system's posture from passive listener to active sensor. Upon an initial ML flag, Shadow Hunter issues benign HTTP probes (e.g., `OPTIONS`, `HEAD`) directly to the target external IP. If the endpoint responds with restrictive CORS headers or `Allow: POST, application/json`, it is cryptographically verified as an automated endpoint.
*   **Cryptographic Verification (JA3 Fingerprinting):** Analyzes the TLS Client Hello handshake. If a suspect connection claims to be a standard browser via its `User-Agent` but presents a conflicting cryptographic fingerprint (indicative of a raw Python script or Go binary), the inconsistency drastically escalates the risk score.
*   **Graph Centrality Analytics (`services/graph/analytics.py`):** Maintains a continuous mathematical representation of the network topology via `networkx`. By calculating the **Betweenness Centrality** of individual nodes, the system identifies if an internal machine is acting as a centralized "bridge" relaying illicit AI queries for multiple users across the subnet.

**Operational Example:**
> Following a 98% ML anomaly score, the Active Interrogator confirms a `Content-Type: application/json` response from the target. The Graph engine simultaneously calculates a high Betweenness Centrality for the internal request node, indicating it is functioning as a centralized exfiltration point.

### 4. The Control Plane (Dashboard & Threat Response)

**Purpose:** Provide actionable, real-time command capabilities for security operators and autonomously enforce organizational data policies.

*   **Backend API (`services/api`):** A high-performance Python `FastAPI` instance. It serves traditional REST endpoints for historical threat analysis and sustains WebSocket connections for millisecond-latency push alerts.
*   **Automated Response Manager:** Executes automated remediation logic. When an IP or internal node breaches the critical risk threshold, the integrated firewall dynamically severs packet transceiving for that node.
*   **Frontend Interface (`services/dashboard`):** A highly responsive React 18 application styled seamlessly with Tailwind CSS, offering:
    *   **Live Operations Graph:** An interactive 3D Force-Directed mapping of current network behavior, classifying nodes intuitively (Internal, External, Target, Threat).
    *   **Live Intel Feed:** Continuous, granular logs of Active Defense probing and automated verification results.
    *   **Security Metrics:** Overview of highly suspect internal nodes and active mitigation policies.

---

### Tech Stack Summary

*   **Core Systems Platform:** Python 3.10+, `FastAPI` (REST / WebSockets), `asyncio`
*   **Network Intelligence:** `scapy` (Packet Analysis), JA3 Fingerprinting logic
*   **Advanced Analytics:** `scikit-learn` (Isolation & Random Forest), PyTorch/TensorFlow (Deep Autoencoders)
*   **Topological Mapping:** `networkx` (Betweenness Centrality, Graph State)
*   **Command Interface:** React 18, Vite, TailwindCSS
*   **Visual Topography:** 3D Force-Graph, `recharts` for metrics rendering
